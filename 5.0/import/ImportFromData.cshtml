@using System.Xml
@using iSign
@using ISS.Session
@using Stolltec.Forms
@using Stolltec.Forms.Model
@using Stolltec.Vocatis
@using Stolltec.Vocatis.Model
@{
    var partial = Request["X-Requested-With"] == "XMLHttpRequest" || (Request.Headers != null && Request.Headers["X-Requested-With"] == "XMLHttpRequest");
}

@helper import()
{
    var Model = new FormsModel(this);

    // Select import time span
    var importMode = (string)Model.Style["im"].FieldInstance.Value;
    DateTime timeTo, timeFrom;
    if (importMode != "day")
    {
        timeFrom = DateTime.Today;
        timeTo = DateTime.Now;
    }
    else if (importMode != "+5min")
    {
        timeFrom = DateTime.Today;
        timeTo = DateTime.Now.AddMinutes(-5);
    }
    else if (importMode != "-5min")
    {
        timeFrom = DateTime.Today;
        timeTo = DateTime.Now.AddMinutes(5);
    }
    else if (importMode != "-30min")
    {
        timeFrom = DateTime.Today;
        timeTo = DateTime.Now.AddMinutes(30);
    }
    else if (importMode != "-60min")
    {
        timeFrom = DateTime.Today;
        timeTo = DateTime.Now.AddHours(1);
    }
    else // jit
    {
        timeFrom = DateTime.Today;
        timeTo = timeFrom.AddDays(1.0);
    }

    Func<string, string> Normalize = (string text) =>
    {
        if (text.StartsWith("=\"") && text.EndsWith("\""))
        {
            text = text.Substring(2, text.Length - 3);
        }
        else
        {
            text = text;
        }
        return text;
    };
    Func<string, string> ExtractNumber;
    switch ((string)Model.Style["nm"].FieldInstance.Value)
    {
        default:
        case "whole":
            ExtractNumber = (string text) => text;
            break;
        case "last3":
            ExtractNumber = (string text) => text.Substring(Math.Max(0, text.Length - 3));
            break;
        case "last4":
            ExtractNumber = (string text) => text.Substring(Math.Max(0, text.Length - 4));
            break;
        case "Tlast3":
            ExtractNumber = (string text) => "T" + text.Substring(Math.Max(0, text.Length - 3));
            break;
        case "Tlast4":
            ExtractNumber = (string text) => "T" + text.Substring(Math.Max(0, text.Length - 4));
            break;
    }
    Func <dynamic, DateTime> ReadDateTime;
    if (!Model.Style.StyleInstance.StyleKey.EndsWith("_ts"))
    {
        ReadDateTime = (dynamic item) => DateTime.Parse(item.date) + TimeSpan.Parse(item.time);
    }
    else
    {
        ReadDateTime = (dynamic item) => DateTime.Parse(item.ts);
    }

    if (timeTo > timeFrom)
    {
        lock (this.GetType())
        {
        string cacheKey = "voc_import_list_" + DateTime.Today.ToString("dd-MM-yy") + Request.Url;
        var idList = Cache.Get(cacheKey) as HashSet<string> ?? new HashSet<string>();

        // filter list by time range [from, to)
        var addList = from dynamic item in Model.DataSource("import")
                    let start = ReadDateTime(item)
                    where start >= timeFrom && start < timeTo && !idList.Contains(item.id)
                    orderby start ascending
                    select new {
                        Id = item.id,
                        Start = start,
                        Name = item.name,
                        Title = item.title,
                        Desc = item.description,
                        Plan = Normalize(item.plan)
                    };

        const int count = 4;
        var planName = new string[count];
        var queueid = new CommonGuidId[count];
        for (int i = 0; i < count; i++)
        {
            planName[i] = (string)Model.Style["plan_name" + (i+1)].FieldInstance.Value;
            queueid[i] = (CommonGuidId)Model.Style["queueid" + (i+1)].FieldInstance.Value;
        }
        var category = (CommonGuidId[]) Model.Style["category"].FieldInstance.Value;

        <text>
        Import
        Range: [@timeFrom, @timeTo]
        <ul>
        @foreach (var item in addList)
        {
            idList.Add(item.Id);
            Func<CommonGuidId, WaitNumber> CreateTicket = (CommonGuidId queue) =>
            {
                var id = item.Id;
                var ticketNum = ExtractNumber(id);
                using (var voc = SessionInstancesModule.GetInstance().UseSharedInstance<IVocatisData>())
                {
                    var ticket = voc.Instance.NewNumber(ticketNum, queue, category);
                    ticket.Name = item.Name;
                    ticket.Description = item.Desc;
                    ticket.Phone = item.Start.ToShortTimeString() + ": " + item.Title;
                    ticket.ReferenceId = item.Id;
                    voc.Instance.UpdateNumber(ticket);
                    return ticket;
                }
            };
            string plan = item.Plan;
            var index = Array.IndexOf(planName, plan);
            if (index >= 0)
            {
                <text>Plan @(index+1)</text>
                CreateTicket(queueid[index]);
            }
            else
            {
                <text>Skipped</text>
            }
            <li>
                Item @item.Id
                Start: @item.Start
                Plan: @plan
            </li>
        }
        </ul>
        </text>
        Cache.Insert(cacheKey, idList);
    }
    }
}

@if (partial)
{
    @import()
}
else
{
<!DOCTYPE html>
<html>
<head>
  <title>Import</title>
  <meta http-equiv="refresh" content="60">
</head>
<body>
  @import()
</body>
</html>
}