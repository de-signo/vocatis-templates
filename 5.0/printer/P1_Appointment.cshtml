@*
  Printer navigation level 1
  Select appointment
*@
@using System.Web.Optimization
@using System.Text.RegularExpressions
@using Stolltec.Forms.Model
@using Stolltec.Vocatis.Model
@using Stolltec.Vocatis
@using ISS.Session
@using iSign

@{
  var showQrCode = true;

  // Parse model
  var Model = new FormsModel(this);

  // setup layout
  PageData["model"] = Model;
  PageData["show_home"] = true;
  PageData["show_back"] = false;

  var partial = Request["X-Requested-With"] == "XMLHttpRequest" || (Request.Headers != null && Request.Headers["X-Requested-With"] == "XMLHttpRequest");
  if (! partial)
  {
    Layout = "PL_Layout.cshtml";
  }

  // Read request
  var s = Request["s"];
  var a = Request["a"];
  var tracking_id = (string)Model.Style["tracking_id"].Value;
  dynamic catids = Model.Style["catid_apt"].Value;
  const int count = 4;
  var planName = new string[count];
  var queueid = new CommonGuidId[count];
  for (int i = 0; i < count; i++)
  {
      planName[i] = (string)Model.Style["plan_name" + (i+1)].FieldInstance.Value;
      queueid[i] = (CommonGuidId)Model.Style["queueid" + (i+1)].FieldInstance.Value;
  }
}
<div class="main">
  <div id="stages">
  @switch (s)
  {
    default:
    case "1":
        <img src="direction.png" alt="direction">
        <h1>Bitte scannen Sie den QR-Code aus Ihrer Terminbestätigung!</h1>
        <textarea id="scan" ></textarea>
      break;
    case "2":
      // Read data
      var re = new Regex("UID[:Ö]([0-9]*)");
      var m = re.Matches(a);
      dynamic entry = null;
      if (m.Count != 1)
      {
        <!-- code: @a -->
        <h2>Ungültiger QR-Code! Ist Ihr Termin heute?</h2>
        <p>Bitte scannen Sie den QR-Code aus ihrer aktuellen Terminbestätigung ein.</p>
      }
      else
      {
        var apt_id = m[0].Groups[1].Value;
        <!-- id: @apt_id -->
        entry = (from dynamic x in Model.DataSource("import")
                where String.Equals(x.id, apt_id)
                select x).FirstOrDefault();
        if (entry == null)
        {
          <h3>Ihr Termin wurde nicht in unserer Liste gefunden.</h3>
        }
        else
        {
          string plan = entry.plan as string;
          var index = Array.IndexOf(planName, plan);
          <!-- index: @index (@plan) -->
          if (index >= 0)
          {
            using (var voc = SessionInstancesModule.GetInstance().UseSharedInstance<IVocatisData>())
            {
              var ticket = voc.Instance.NewNumber(queueid[index], catids);
              ticket.Name = entry.name;
              ticket.Description = entry.time;
              voc.Instance.UpdateNumber(ticket);

              <img src="registration.png" id="registration" alt="registration" />
              <h3>Sie sind angemeldet</h3>
              <p>Bitte noch etwas Geduld, drucken oder scannen Sie Ihr Ticket und warten bis Ihre Nummer aufgerufen wird.</p>
              <div class="left">
                <p>Ticket drucken</p>
                <a class="print-button" href='@Href("PrinterTicket.cshtml", new { id=ticket.Id, tid=tracking_id })'><img src="printer.png" alt="Drucker"> </a>
              </div>
              if (showQrCode)
              {
                <div class="right">
                  <p>Ticket scannen</p>
                  <div class="qrcode" data-url="@Href("App.cshtml", new {id=ticket.Id, tracking_id})"></div>
                </div>
              }
            }
          }
          else
          {
            <h3>Dieses Gerät ist nicht für Ihren Termin konfiguriert, bitte wenden Sie sich an die korrekte Stelle.</h3>
          }
        }
      }
      break;
  }
  </div>

  @if (! partial)
  {
    <div id="loading" style="display: none;">
      <h3>Einen Moment, Ihr Code wird geprüft.</h3>
    </div>
    @* wait popup is shown, while generating a new number *@
    <section id="waitPopup" style="display: none;">
      <h4>Ihre Wartemarke wird gedruckt</h4>
      <div>
        <img src="wait.gif" id="wait" alt="wait" />
      </div>
      <h4>Bitte entnehmen Sie Ihre Wartenummer</h4>
      <img src="PfeilRechts.png" />
    </section>

    @* take popup is shown, when the printout is ready *@
    <section id="takePopup" style="display: none;">
        <h4>Ihre Wartemarke wird gedruckt</h4>
      <div>
        <img src="wait.gif" id="wait" alt="wait" />
      </div>
      <h4>Bitte entnehmen Sie Ihre Wartenummer</h4>
      <img src="PfeilRechts.png" />
    </section>

    @* show popup shows the number on the screen *@
    <section id="showPopup" style="display: none;">
      <h3>Sie werden angemeldet im Fachbereich</h3>
      <h2 data-name></h2>
      <p>Bitte merken Sie sich Ihre Anmeldenummer:</p>
      <div class="number" data-number></div>
      <p>Sie werden aufgerufen</p>
    </section>
  }
</div>

@if (! partial)
{
  <script type="text/javascript">
    @* load site *@
    function hookupSite() {
      @* Qr code *@
      // make absolute  
      var a = document.createElement("a");
      a.href = $(".qrcode").data("url");
      $(".qrcode").qrcode({
        text: a.href,
        fill: '#706f6f',
        background: '#dadada'
      });

      @* Printing *@
      $(".print-button").unbind()
        .printTicket({
          legacy: false,
          printErrorTimeout: 60000,
          stripBody: false,
          beginPrint: function() {
            $("#waitPopup").show();
          },
          endPrint: function() {
            $("#waitPopup").hide();
            $("#takePopup").show();
            window.setTimeout(function() { $("#takePopup").hide(); }, 3000);
          },
          failPrint: function() {
            $("#waitPopup").hide();
          }
        });
    }
    @* scan logic *@
    function loadStage2(text) {
      $("#stages").html($("#loading").html());
      var url = '@Html.Raw(Model.Navigate("P1_Appointment.cshtml", new { s="2", a="--text--"}))';
      url = url.replace("--text--", encodeURI(text));
      $.ajax({
        url: url,
        cache: false
      }).done(function (result) {
        $("#stages").html($(result).html());
        hookupSite();
      });
    }
    @if (String.IsNullOrEmpty(s) && !String.IsNullOrEmpty(a))
    {
      <text>loadStage2('@Html.Raw(a.Replace("\n", "\\n").Replace("\r", "\\r"))');</text>
    }
    var timeoutHandle = null;
    $('#scan').on("keydown", function() {
      if (timeoutHandle) {
        window.clearTimeout(timeoutHandle);
      }
      timeoutHandle = window.setTimeout(function() {
        loadStage2($("#scan").val());
      }, 100);
    }).blur(function() {
      window.setTimeout(function () { $("#scan").focus(); }, 20);
    }).focus();
    hookupSite();

    $(document).ready(function () {
      reportPrinterStatus({
        url: "@Href(Stolltec.Forms.PrinterStatus.Path)",
        interval: 60000
      });
    });
  </script>
}