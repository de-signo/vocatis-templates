@using Newtonsoft.Json
@using Stolltec.Forms.Model
@using Stolltec.Vocatis
@using Stolltec.Vocatis.Model
@using System.Globalization
@using System.Threading
@{
  Response.ContentType="application/json";

  var debug = Request["d"] != null;
  var model = new FormsModel(this);
  var datef = (string)model.Style["datef"].FieldInstance.Value;
  IFormatProvider format;
  if (datef == "iso8601")
  {
    format = null;
  }
  else
  {
    format = CultureInfo.GetCultureInfo(datef);
  }

  var today = DateTime.Today;
  var appts = (from x in model.DataSource("import")
               let date =  DateTime.Parse(x["date"] as string, format, DateTimeStyles.AssumeLocal)
               where debug || date == DateTime.Today
               select new {
                  id = x["id"],
                  @ref = x["ref"],
                  plan = x["plan"],
                  time = date + TimeSpan.Parse(x["time"] as string, format),
                  title =  x["title"],
                  name = x["name"]
               });

  Response.ContentType = "application/json";
}
@Html.Raw(JsonConvert.SerializeObject(appts))
