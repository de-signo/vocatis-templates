@using System.Web.Optimization
@using Stolltec.Forms.Model
@{
  // Parse model
  var Model = new FormsModel(this);
  var mode = (string)Model.Style["mode"].FieldInstance.Value;

  // setup layout
  PageData["model"] = Model;
  PageData["show_home"] = Model.Style.StyleInstance.StyleKey == "vocm19ap";
  Layout = "PL_Layout.cshtml";
}
<div class="main">
  @* Display list when idle *@
  <div id="queuelist" data-content-src="@Model.Navigate("QueueList.cshtml")">
  </div>

  @* wait popup is shown, while generating a new number *@
  <section id="waitPopup" style="display: none;">
    <h4>Ihre Wartemarke wird gedruckt</h4>
    <div>
      <img src="wait.gif" id="wait" alt="wait" />
    </div>
    <p>Bitte entnehmen Sie Ihre Wartenummer</p>
    <img src="PfeilUnten.png" />
  </section>

  @* take popup is shown, when the printout is ready *@
  <section id="takePopup" style="display: none;">
      <h4>Ihre Wartemarke wird gedruckt</h4>
    <div>
      <img src="wait.gif" id="wait" alt="wait" />
    </div>
    <h4>Bitte entnehmen Sie Ihre Wartenummer</h4>
    <img src="PfeilUnten.png" />
  </section>

  @* show popup shows the number on the screen *@
  <section id="showPopup" style="display: none;">
    <h3>Sie werden angemeldet im Fachbereich</h3>
    <h2 data-name></h2>
    <p>Bitte merken Sie sich Ihre Anmeldenummer:</p>
    <div class="number" data-number></div>
    <p>Sie werden aufgerufen</p>
  </section>
</div>

<script type="text/javascript">
@if (mode == "print") {
  @*
    This script calls the number generation service
    and prints the number on the default printer.
    It shows the wait popup while waiting and printing.
    It shows the take popup when the printout is ready.
    It reports the printer status to the service.
   *@
  <text>
  function hookupButtons() {
    $("a.btn").unbind()
    .each(function (){
      // do not block
      var url = $(this).find(".qrcode").data("url");
      if (url) {
          // make absolute
          var a = document.createElement("a");
          a.href = url;
          url = a.href;
      }

      $(this).find(".qrcode").qrcode({text: url});
    }).click(function() {
      $("[data-name]").text($(this).data("label"));
    }).printTicket({
      legacy: false,
      printErrorTimeout: 60000,
      stripBody: false,
      beginPrint: function() {
        $("#waitPopup").show();
      },
      endPrint: function() {
        $("#waitPopup").hide();
        $("#takePopup").show();
        window.setTimeout(function() { $("#takePopup").hide(); }, 3000);
      },
      failPrint: function() {
        $("#waitPopup").hide();
      }
    });
  }
  $(document).ready(function () {
    reportPrinterStatus({
      url: "@Href(Stolltec.Forms.PrinterStatus.Path)",
      interval: 60000
	  });
  });
  </text>
} else {
  @*
    This script calls the number generation service,
    shows the wait popup while waiting and
    shows the number in show popup when done.
   *@
  <text>
  function hookupButtons() {
  
    $("a.btn").unbind()
    .each(function (){
      // do not block
      var url = $(this).find(".qrcode").data("url");
      if (url) {
          // make absolute
          var a = document.createElement("a");
          a.href = url;
          url = a.href;
      }
      $(this).find(".qrcode").qrcode({text: url});
    })
    .click(function (ev) {
      ev.preventDefault();
      
      // do not block
      var url = $(this).attr("href");
      if (!url)
          url = $(this).data("href");
      if (url) {
          // make absolute
          var a = document.createElement("a");
          a.href = url;
          url = a.href;
      }

      $("[data-name]").text($(this).data("label"));
      $("#waitPopup").show();
      $.ajax({url:url, cache: false, dataType:"json"}).done(function(data) {
        $("[data-number]").text(data["number"]);
        $("#showPopup").show();
        window.setTimeout(function() {
          $("#showPopup").hide();
        }, 10000);
      }).always(function() {
        $("#waitPopup").hide();
      });
    });
  }
  </text>
}
  $(document).ready(function() {
    @* update queue list periodically *@
    var queueList = $("#queuelist");
    var queueListUrl = queueList.data("content-src");
    var update = function () {
      try {
          $.ajax({
              url: queueListUrl,
              cache: false
          }).done(function (result) {
              queueList.html(result);
              hookupButtons();
          });
      }
      finally {
          window.setTimeout(update, 20000);
      }
    };
    window.setTimeout(update, 0);
  });
</script>
