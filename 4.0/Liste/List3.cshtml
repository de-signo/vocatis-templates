@using System.Web.Optimization
@using Stolltec.Forms.Model
@{
    var Model = new FormsModel(this);
    var list1 = Model.DataSource("source1").Select(x => new {
                   number = x["number1"],
                   room = x["room1"]
               });
    var list2 = Model.DataSource("source2").Select(x => new {
                   number = x["number2"],
                   room = x["room2"]
               });
    var list3 = Model.DataSource("source3").Select(x => new {
                   number = x["number3"],
                   room = x["room3"]
               });

    var list = list1.Concat(list2).Concat(list3);
    // the $.fn.vocatisList function requests the page to update the view
    // We minimize the overhead by just sending the required contents.
    var partial = Request["X-Requested-With"] == "XMLHttpRequest" || (Request.Headers != null && Request.Headers["X-Requested-With"] == "XMLHttpRequest");
}

@helper ItemsList(IEnumerable<dynamic> list) {
<table id="list">
    <tbody>
        @foreach (var x in list) {
        <tr>
            <td class="number">@x.number</td>
            <td class="room">@x.room</td>
        </tr>
        <tr class="spacer">
            <td colspan="2"></td>
        </tr>
        }
    </tbody>
</table>
}
@if (partial) {
    @ItemsList(list)
}
else {
<!DOCTYPE html>
<html>
<head>
    <title>Vocatis</title>
    <link href="@Href("Vocatis.css")" type="text/css" rel="Stylesheet" />
</head>
<body class="list">
    @Scripts.Render("~/Scripts/jquery", "~/Scripts/forms", "~/Scripts/vocatis.js")

    <h1>
        Bitte warten Sie, <br /> bis Ihre Nummer erscheint:
    </h1>
    @ItemsList(list)

    @{
        var notify = Model.Style["notify"].FieldInstance.Value as string;
        var popup = Model.Style["popup"].FieldInstance.Value as string;
    }
    @if (!String.IsNullOrEmpty(notify)) {
    <audio id="notify">
        <source src="@Href(notify)" type="audio/mp3" />
    </audio>
    }
    @if (!String.IsNullOrEmpty(popup)) {
        <div id="popup" style="display:none;" class="popup @popup">
            <h3>~room~</h3>
            <h4>~number~</h4>
        </div>
    }
    <script type="text/javascript">
    $(document).ready(function() {
        var popupContent = $("#popup").html();

        $("#list")
            .vocatisList({
                interval: 2500
            })
            .highlightNumbers({
                items:"tr:not(.spacer)",
                call: function(items) {
                    var audio = document.getElementById("notify");
                    if (audio) audio.play();

                    if (popupContent) {
                            $("#popup").html(popupContent.replace("~number~", items[0].number).replace("~room~", items[0].room)).show();
                            window.setTimeout(function () { $("#popup").hide(); }, 10000);
                    }
                }
            });
    });
    </script>
</body>
</html>
}